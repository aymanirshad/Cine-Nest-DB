<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - Cine Nest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        /* --- GLOBAL & HEADER --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        :root { --primary: #561c24; --secondary: #c7b7a3; --accent-dark: #6d2932; --accent-light: #e8d8c4; --white: #ffffff; }
        body { background-color: #f4e9d8; color: var(--primary); padding-top: 80px; }
        header { background-color: var(--primary); color: var(--white); padding: 10px 0; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .header-container { display: flex; align-items: center; justify-content: space-between; width: 90%; margin: auto; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 20px; }
        .logo img { height: 40px; width: 40px; border-radius: 50%; object-fit: cover; }
        nav ul { list-style: none; display: flex; gap: 20px; }
        nav ul li a { color: white; text-decoration: none; font-size: 15px; }
        
        /* --- PROFILE SPECIFIC --- */
        .profile-header { width: 90%; max-width: 1000px; margin: 20px auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px; }
        .profile-pic { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent-light); }
        .user-info h2 { margin-bottom: 5px; color: var(--primary); }
        .bio { color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        .stats { display: flex; gap: 20px; margin-top: 10px; }
        .stats div { text-align: center; font-size: 0.9rem; color: #555; }
        .stats .num { display: block; font-size: 1.2rem; font-weight: bold; color: var(--accent-dark); }
        .num-link { text-decoration: none; color: inherit; }

        .section-block { width: 90%; max-width: 1000px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section-title { display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid var(--accent-light); padding-bottom: 10px; margin-bottom: 15px; }
        .section-title h3 { color: var(--primary); margin: 0; }
        .arrow { cursor: pointer; font-size: 1.2rem; color: var(--primary); }

        /* Genres */
        .genre-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .genre-checkbox { display: none; }
        .genre-label { display: block; background: var(--accent-light); padding: 8px; text-align: center; border-radius: 20px; cursor: pointer; font-size: 13px; }
        .genre-checkbox:checked + .genre-label { background: var(--primary); color: white; }
        .save-btn { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; margin-top: 10px; border-radius: 5px; cursor: pointer; }

        /* Movie Rows */
        .movie-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .movie-card { min-width: 140px; cursor: pointer; transition: 0.3s; }
        .movie-card:hover { transform: scale(1.05); }
        .movie-card img { width: 100%; height: 200px; object-fit: cover; border-radius: 5px; }
        .movie-card h3 { font-size: 0.9rem; text-align: center; margin-top: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Friends */
        .friend-preview { display:flex; flex-direction:column; align-items:center; gap:5px; }
        .friend-preview img { width:60px; height:60px; border-radius:50%; object-fit:cover; }

        /* Tabs */
        .tabs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .tab { text-decoration: none; color: var(--primary); padding: 8px 16px; border-radius: 20px; background: #fff; font-weight: bold; font-size: 14px; }
        .tab.active { background: var(--primary); color: white; }

        footer { text-align: center; padding: 20px; margin-top: 40px; color: var(--primary); }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo"><img src="photos/logo.jpg" alt="Logo" onerror="this.style.display='none'"><span class="site-name">Cine Nest</span></div>
            <nav>
                <ul>
                    <li><a href="home.html">Home</a></li>
                    <li><a href="movie.html">Movies</a></li>
                    <li><a href="watchlist.html">Watchlist</a></li>
                    <li><a href="profile.html">Profile</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="profile-header">
        <img src="photos/profile.jpg" alt="User" class="profile-pic" onerror="this.src='photos/default_user.jpg'">
        <div class="user-info">
            <h2 id="profile-name">Loading...</h2>
            <p class="bio" id="profile-email">...</p>
            <div class="stats">
                <div><a href="history.html" class="num-link"><span class="num" id="stat-history">0</span> Completed</a></div>
                <div><a href="friends.html" class="num-link"><span class="num" id="stat-friends">0</span> Friends</a></div>
                <div><span class="num" id="stat-reviews">0</span> Reviews</div>
            </div>
        </div>
    </section>

    <!-- Navigation Tabs (Updated) -->
    <div class="tabs">
        <a href="profile.html" class="tab active">Overview</a>
        <a href="history.html" class="tab">History</a>
        <a href="watchlist.html" class="tab">Watchlist</a>
        <a href="friends.html" class="tab">Friends</a>
        <a href="reviews.html" class="tab">Reviews</a> <!-- Added -->
        <a href="notifications.html" class="tab">Notifications</a> <!-- Added -->
        <a href="dm.html" class="tab">Messages</a>
    </div>

    <!-- Genre Selection -->
    <section class="section-block">
        <div class="section-title"><h3>Favorite Genres</h3></div>
        <form id="genre-form">
            <div class="genre-grid">
                <div><input type="checkbox" id="g1" name="genres" value="1" class="genre-checkbox"><label for="g1" class="genre-label">Action</label></div>
                <div><input type="checkbox" id="g2" name="genres" value="2" class="genre-checkbox"><label for="g2" class="genre-label">Drama</label></div>
                <div><input type="checkbox" id="g3" name="genres" value="3" class="genre-checkbox"><label for="g3" class="genre-label">Comedy</label></div>
                <div><input type="checkbox" id="g4" name="genres" value="4" class="genre-checkbox"><label for="g4" class="genre-label">Sci-Fi</label></div>
                <div><input type="checkbox" id="g5" name="genres" value="5" class="genre-checkbox"><label for="g5" class="genre-label">Romance</label></div>
                <div><input type="checkbox" id="g6" name="genres" value="6" class="genre-checkbox"><label for="g6" class="genre-label">Thriller</label></div>
                <div><input type="checkbox" id="g7" name="genres" value="7" class="genre-checkbox"><label for="g7" class="genre-label">Horror</label></div>
            </div>
            <button type="submit" class="save-btn">Save & Update Recommendations</button>
        </form>
    </section>

    <!-- Recommendations -->
    <div class="section-block">
        <div class="section-title"><h3>Recommended for You</h3></div>
        <div class="movie-row" id="recommendation-container">
            <p style="padding:10px; color:#777;">Select genres above to see movies!</p>
        </div>
    </div>

    <!-- Recently Completed -->
    <div class="section-block">
        <div class="section-title">
            <h3>Recently Completed</h3>
            <span class="arrow" onclick="location.href='history.html'">➜</span>
        </div>
        <div class="movie-row" id="history-preview">
            <p style="padding:10px; color:#777;">No history yet.</p>
        </div>
    </div>

    <!-- Watchlist -->
    <div class="section-block">
        <div class="section-title">
            <h3>Watchlist</h3>
            <span class="arrow" onclick="location.href='watchlist.html'">➜</span>
        </div>
        <div class="movie-row" id="watchlist-preview">
            <p style="padding:10px; color:#777;">Watchlist empty.</p>
        </div>
    </div>

    <!-- Friends -->
    <div class="section-block">
        <div class="section-title">
            <h3>Friends</h3>
            <span class="arrow" onclick="location.href='friends.html'">➜</span>
        </div>
        <div class="movie-row" id="friends-preview">
            <p style="padding:10px; color:#777;">No friends yet.</p>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Cine Nest. All Rights Reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/social/profile')
                .then(res => {
                    if(res.status === 401) { window.location.href = 'login.html'; return null; }
                    return res.json();
                })
                .then(data => {
                    if (data && data.user) {
                        const u = data.user;
                        document.getElementById('profile-name').textContent = `${u.first_name} ${u.last_name}`;
                        document.getElementById('profile-email').textContent = `@${u.username}`;
                        document.getElementById('stat-history').textContent = data.stats.historyCount;
                        document.getElementById('stat-friends').textContent = data.stats.friendCount;
                        document.getElementById('stat-reviews').textContent = data.stats.reviewCount;

                        if(data.favGenres) {
                            data.favGenres.forEach(id => {
                                const box = document.getElementById(`g${id}`);
                                if(box) box.checked = true;
                            });
                        }
                        
                        loadRecommendations();
                        loadHistoryPreview();
                        loadWatchlistPreview();
                        loadFriendsPreview();
                    }
                })
                .catch(console.error);

            document.getElementById('genre-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const checkboxes = document.querySelectorAll('input[name="genres"]:checked');
                const selectedIds = Array.from(checkboxes).map(cb => cb.value);

                fetch('/social/genres', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ genre_ids: selectedIds })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadRecommendations();
                })
                .catch(err => alert("Error saving genres"));
            });

            function loadRecommendations() {
                fetch('/social/recommendations')
                    .then(res => res.json())
                    .then(renderMovies('recommendation-container'));
            }
            function loadHistoryPreview() {
                fetch('/social/history')
                    .then(res => res.json())
                    .then(data => renderMovies('history-preview')(data.slice(0,5)));
            }
            function loadWatchlistPreview() {
                fetch('/social/watchlist')
                    .then(res => res.json())
                    .then(renderMovies('watchlist-preview'));
            }
            function loadFriendsPreview() {
                fetch('/social/friends')
                    .then(res => res.json())
                    .then(friends => {
                        const container = document.getElementById('friends-preview');
                        if(friends.length > 0) container.innerHTML = '';
                        friends.slice(0, 5).forEach(f => {
                            const pid = (f.account_id % 6) + 1;
                            container.innerHTML += `
                                <div class="friend-preview">
                                    <img src="photos/friend${pid}.jpg" alt="${f.first_name}">
                                    <span>${f.first_name}</span>
                                </div>
                            `;
                        });
                    });
            }

            const renderMovies = (containerId) => (movies) => {
                const container = document.getElementById(containerId);
                if (movies && movies.length > 0) container.innerHTML = '';
                movies.forEach(m => {
                    container.innerHTML += `
                        <div class="movie-card" onclick="location.href='movie_detail.html?id=${m.movie_id}'">
                            <img src="${m.poster || 'photos/default.jpg'}" onerror="this.src='photos/default.jpg'">
                            <h3>${m.title}</h3>
                        </div>
                    `;
                });
            };
        });
    </script>
</body>
</html>